# Load required libraries
library(shiny)
library(readr)
library(readxl)
library(dplyr)
library(ggplot2)
library(plotly)
library(rstatix)
library(bslib)
library(DT)

# Server
server <- function(input, output, session) {
  
  # Reactive values untuk menyimpan hasil
  values <- reactiveValues(
    data = NULL,
    spearman_result = NULL,
    cramer_result = NULL,
    correlation_matrix = NULL,
    download_ready = FALSE
  )
  
  # Load data dengan error handling
  observeEvent(input$file, {
    tryCatch({
      ext <- tools::file_ext(input$file$name)
      if (ext == "csv") {
        values$data <- read_csv(input$file$datapath, locale = locale(encoding = "UTF-8"))
      } else if (ext == "xlsx") {
        values$data <- read_excel(input$file$datapath)
      }
      
      # Reset download status ketika file baru diupload
      values$download_ready <- FALSE
      
      # Gunakan showModal untuk menampilkan pesan sukses
      showModal(modalDialog(
        title = "âœ… Upload Berhasil",
        "Data berhasil dimuat!",
        easyClose = TRUE,
        footer = modalButton("OK")
      ))
      
    }, error = function(e) {
      # Gunakan showModal untuk menampilkan pesan error
      showModal(modalDialog(
        title = "âŒ Error Loading File",
        paste("Terjadi kesalahan saat memuat file:", e$message),
        easyClose = TRUE,
        footer = modalButton("OK")
      ))
    })
  })
  
  output$preview <- DT::renderDataTable({
    req(values$data)
    DT::datatable(
      values$data,
      options = list(
        scrollX = TRUE,
        pageLength = 10,
        dom = 'Bfrtip',
        buttons = c('copy', 'csv', 'excel')
      ),
      class = "display table-striped table-hover"
    )
  })
  
  output$summary <- renderPrint({
    req(values$data)
    summary(values$data)
  })
  
  output$spearman_ui <- renderUI({
    req(values$data)
    num_vars <- names(select_if(values$data, is.numeric))
    
    if(length(num_vars) < 2) {
      div(
        style = "color: #dc3545; font-style: italic; font-weight: 500;",
        "Minimal diperlukan 2 variabel numerik untuk uji Spearman"
      )
    } else {
      tagList(
        div(
          style = "margin-bottom: 10px;",
          strong("Variabel Numerik X:", style = "color: #212529; font-size: 14px; font-weight: bold;")
        ),
        selectInput(
          "spearman_x", 
          label = NULL,
          choices = num_vars,
          selected = num_vars[1]
        ),
        div(
          style = "margin-bottom: 10px; margin-top: 15px;",
          strong("Variabel Numerik Y:", style = "color: #212529; font-size: 14px; font-weight: bold;")
        ),
        selectInput(
          "spearman_y", 
          label = NULL,
          choices = num_vars,
          selected = if(length(num_vars) > 1) num_vars[2] else num_vars[1]
        )
      )
    }
  })
  
  output$cramer_ui <- renderUI({
    req(values$data)
    # Identifikasi variabel kategorik dengan lebih robust
    cat_vars <- names(values$data)[sapply(values$data, function(x) {
      is.factor(x) || is.character(x) || (is.numeric(x) && length(unique(x)) <= 10)
    })]
    
    if(length(cat_vars) < 2) {
      div(
        style = "color: #dc3545; font-style: italic; font-weight: 500;",
        "Minimal diperlukan 2 variabel kategorik untuk uji CramÃ©r's V"
      )
    } else {
      tagList(
        div(
          style = "margin-bottom: 10px;",
          strong("Variabel Kategorik A:", style = "color: #212529; font-size: 14px; font-weight: bold;")
        ),
        selectInput(
          "cramer_x", 
          label = NULL,
          choices = cat_vars,
          selected = cat_vars[1]
        ),
        div(
          style = "margin-bottom: 10px; margin-top: 15px;",
          strong("Variabel Kategorik B:", style = "color: #212529; font-size: 14px; font-weight: bold;")
        ),
        selectInput(
          "cramer_y", 
          label = NULL,
          choices = cat_vars,
          selected = if(length(cat_vars) > 1) cat_vars[2] else cat_vars[1]
        )
      )
    }
  })
  
  output$download_ui <- renderUI({
    # Tampilkan tombol download SETELAH analisis berhasil
    if(values$download_ready) {
      downloadButton(
        "download_report",
        label = tagList(icon("download"), "Download Laporan Word"),
        class = "btn btn-info btn-lg",
        style = "width: 100%; font-weight: bold; margin-top: 10px; padding: 12px; color: white; background-color: #17a2b8; border-color: #17a2b8;"
      )
    } else {
      div(
        style = "color: #495057; font-style: italic; text-align: center; margin-top: 10px; font-weight: 500;",
        "Lakukan analisis terlebih dahulu untuk mengunduh laporan"
  Â Â Â Â )
Â Â Â Â }
Â Â })



output$download_report <- downloadHandler(
  filename = function() {
    paste("Laporan_Analisis_", Sys.Date(), ".docx", sep = "")
  },
  content = function(file) {
    # Memunculkan progress message menggunakan showNotification
    notification_id <- showNotification(
      "ðŸ”„ Sedang mempersiapkan laporan Word...", 
      duration = NULL, 
      type = "message"
    )
    
    tryCatch({
      # Buat file RMD sementara
      tempReport <- file.path(tempdir(), "report.Rmd")
      
      # Buat isi dari RMD ke file sementara
      writeLines(rmd_content, tempReport)
      
      # Render dokumen dengan parameter
      rmarkdown::render(
        input = tempReport,
        output_format = rmarkdown::word_document(),
        output_file = file,
        params = list(
          spearman = values$spearman_result,
          cramer = values$cramer_result,
          correlation = values$correlation_matrix
        ),
        envir = new.env(parent = globalenv()),
        quiet = TRUE
      )
      
      # Menghilangkan notifikasi progres
      removeNotification(notification_id)
      
      # Memunculkan notifikasi berhasil
      showNotification(
        "âœ… Laporan Word berhasil diunduh!", 
        duration = 5, 
        type = "message"
      )
      
    }, error = function(e) {
      # Menghilangkan notifikasi progres
      removeNotification(notification_id)
      
      # Memunculkan notifikasi error
      showNotification(
        paste("âŒ Error membuat laporan:", e$message), 
        duration = 10, 
        type = "error"
      )
      
      print(paste("Debug error:", e$message))  # For debugging
    })
  }
)

 # Render hasil Spearman
  output$spearman_result <- renderPrint({
    req(values$spearman_result)
    test <- values$spearman_result$test
    cat("Metode:", test$method, "\n")
    cat("Koefisien rho:", round(test$estimate, 4), "\n")
    cat("p-value:", format(test$p.value, scientific = TRUE), "\n")
    if(!is.null(test$conf.int)) {
      cat("95% CI:", paste(round(test$conf.int, 4), collapse = " - "), "\n")
    }
  })
  
  output$spearman_plot <- renderPlotly({
    req(values$spearman_result)
    
    spearman_data <- values$spearman_result$data
    p <- ggplot(spearman_data, aes(x = x, y = y)) +
      geom_point(color = "#E74C3C", alpha = 0.6, size = 2) +
      geom_smooth(method = "lm", se = TRUE, color = "#3498DB", fill = "#AED6F1") +
      theme_minimal() +
      theme(
        plot.title = element_text(size = 14, face = "bold", color = "#2c3e50"),
        axis.title = element_text(size = 12, color = "#2c3e50"),
        axis.text = element_text(size = 10, color = "#34495e"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "#ecf0f1", size = 0.5)
      ) +
      labs(
        title = paste("Scatterplot:", values$spearman_result$x, "vs", values$spearman_result$y),
        x = values$spearman_result$x, 
        y = values$spearman_result$y
      )
    
    ggplotly(p, tooltip = c("x", "y"))
  })
  
  output$spearman_interpretation <- renderUI({
    req(values$spearman_result)
    
    test <- values$spearman_result$test
    r <- round(test$estimate, 3)
    pval <- test$p.value
    
    # Interpretasi kekuatan korelasi
    strength <- if(abs(r) >= 0.7) "kuat" else if(abs(r) >= 0.3) "sedang" else "lemah"
    direction <- if(r > 0) "positif" else "negatif"
    
    interpret <- if (pval < 0.05) {
      paste0("âœ… <strong style='color: #28a745; font-weight: bold;'>Signifikan</strong> (p < 0.05): Terdapat korelasi yang signifikan antara variabel.")
    } else {
      paste0("âŒ <strong style='color: #dc3545; font-weight: bold;'>Tidak signifikan</strong> (p > 0.05): Tidak terdapat korelasi yang signifikan antara variabel.")
    }
    
    HTML(paste0(
      "<div style='background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #17a2b8; border: 1px solid #dee2e6;'>",
      "<h5 style='color: #212529; margin-bottom: 10px; font-weight: bold;'>ðŸ“Š Interpretasi Hasil</h5>",
      "<p style='color: #212529; font-weight: 500;'><strong>Korelasi:</strong> ", r, " (", strength, ", ", direction, ")</p>",
      "<p style='color: #212529; font-weight: 500;'>", interpret, "</p>",
      "</div>"
    ))
  })
  
  output$spearman_detail <- renderUI({
    req(values$spearman_result)
    
    HTML(paste0(
      "<div style='background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; border: 1px solid #ffeaa7;'>",
      "<h6 style='color: #212529; font-weight: bold;'>ðŸ’¡ Penjelasan Uji Spearman</h6>",
      "<p style='margin-bottom: 5px; color: #212529; font-weight: 500;'><strong>Tujuan:</strong> Mengukur kekuatan dan arah hubungan monoton antara dua variabel numerik</p>",
      "<p style='margin-bottom: 5px; color: #212529; font-weight: 500;'><strong>Asumsi:</strong> Data tidak harus terdistribusi normal</p>",
      "<p style='margin: 0; color: #212529; font-weight: 500;'><strong>Interpretasi rho:</strong> -1 (korelasi negatif sempurna) hingga +1 (korelasi positif sempurna)</p>",
      "</div>"
    ))
  })
